function GuessBlindly(){this.record={};this.param={};this.param.answer=0;this.param.endTime=0;this.param.startTime=0;this.param.totalTime=1*30*1000;this.param.restTime=1*10*1000;
this.guess={};this.users={};this.lib={};this.lib.sio=require("socket.io");this.lib.comm=require("./core");this.lib.mysql=require("./libc.mysql");this.lib.mysql.init();
this.init();this.res=null;var a=this;a.setStart();}GuessBlindly.prototype.init=function(){for(var a=1;a<=9;a++){this.record[a]={number:0,key:a,user:{}};
}};GuessBlindly.prototype.setReset=function(){for(var a in this.record){this.record[a].number=0;this.record[a].user={};}return this.record;};GuessBlindly.prototype.opt=function(a,b){this.record[b].number+=1;
if(this.record[b].user[a]){this.record[b].user[a].a+=1;}else{this.record[b].user[a]={a:1,b:0};}return this.record[b];};GuessBlindly.prototype.get=function(){var a=[];
for(var b in this.record){a.push(this.record[b].number);}return a;};GuessBlindly.prototype.setStart=function(){var a=this;a.param.startTime=new Date().getTime();
a.param.endTime=a.param.startTime+a.param.totalTime;a.param.answer=parseInt(Math.random()*9)||9;a.param.timeout=setTimeout(function(){a.setRight();},a.param.totalTime);
clearInterval(a.param.inverval);a.param.inverval=setInterval(function(){a.setStart();a.init();a.res.emit("send guess blindly",a.getAll());a.res.broadcast.emit("send guess blindly",a.getAll());
},a.param.totalTime+a.param.restTime);};GuessBlindly.prototype.getAll=function(){return{record:this.record,status:this.param.endTime>new Date().getTime(),startTime:this.param.startTime,endTime:this.param.endTime,totalTime:this.param.totalTime};
};GuessBlindly.prototype.socket=function(d){var b=this.lib.sio.listen(d);var c=this;var a=null;b.on("connection",function(e){c.res=e;c.that.finish=function(f){console.log("that.finish",this.record);
e.send(this.record);e.emit("send ux001",this.record);e.broadcast.emit("send ux001",this.record);};e.on("Identity",function(f){c.users[f.key]=f;});e.on("get guess blindly",function(){e.emit("send guess blindly",c.getAll());
});e.on("opt guess blindly",function(h){var f=c.users[h.userkey],g=null;if(f&&f.sum>0){g=c.opt(h.userkey,h.key);f.sum-=1;c.lib.mysql.setSum(f.key,f.sum,function(){e.emit("send userinfo sum",f.sum);
});e.emit("send guess blindly item",g);e.broadcast.emit("send guess blindly item",g);}});e.on("get my income",function(f){c.users[f]=userinfo;});e.on("disconnect",function(){console.log("close 001...!");
});console.log("open 001...!");e.send("welcome to 001.");});};GuessBlindly.prototype.setRight=function(){var b=null,e=0;for(b in this.record){e+=this.record[b].number;
}var d=this.record[this.param.answer];var c=this,a=null;for(b in d.user){d.user[b].b=parseInt(d.user[b].a/d.number*e);a=c.users[b];c.lib.mysql.setSum(b,a.sum+d.user[b].b);
}this.res.emit("reveal answer",c.param.answer,d.user);this.res.broadcast.emit("send ux001",d.user,d.user);console.log("计算后 winner",d);};module.exports=new GuessBlindly();
